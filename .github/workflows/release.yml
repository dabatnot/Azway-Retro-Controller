name: Release Firmware

on:
 push:
  tags:
   - 'v*.*.*'

jobs:
 release:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout repository
     uses: actions/checkout@v2

   - name: Set up Python
     uses: actions/setup-python@v2
     with:
      python-version: '3.x'

   - name: Install dependencies
     run: pip install -U platformio

   - name: Build Project
     run: pio run

   - name: Archive Binaries
     run: zip -j firmware.zip .pio/build/your_environment/firmware.bin

   - name: Create Release
     id: create_release
     uses: ncipollo/release-action@v1
     with:
      token: ${{ secrets.PAT_TOKEN }}
      tag: ${{ github.ref_name }}
      name: Release ${{ github.ref_name }}
      body: 'Automated release of the firmware'
      draft: false
      prerelease: false

   - name: Upload Release Asset
     run: |
      UPLOAD_URL="${{ steps.create_release.outputs.upload_url }}"
      UPLOAD_URL="${UPLOAD_URL/\{?name,label\}/}"
      echo "Uploading to $UPLOAD_URL"
      curl -X POST \
           -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
           -H "Content-Type: multipart/form-data" \
           -F "file=@firmware.zip" \
           "$UPLOAD_URL?name=firmware.zip&label=Firmware"
