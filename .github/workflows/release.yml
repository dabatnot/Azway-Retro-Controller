env:
 VERSION: v1.0.0

jobs:
 build:
  runs-on: ubuntu-latest

  steps:
   - name: Checkout repository
     uses: actions/checkout@v2

   - name: Set up Python
     uses: actions/setup-python@v2
     with:
      python-version: '3.x'

   - name: Install PlatformIO
     run: pip install -U platformio

   - name: Build Project
     run: pio run

   - name: Create build directory
     run: mkdir -p .pio/build/esp32dev/

   - name: Copy Static File
     run: cp static_bins/boot_app0.bin .pio/build/esp32dev/

   - name: Archive Binaries
     run: zip -j firmware.zip .pio/build/esp32dev/firmware.bin .pio/build/esp32dev/boot_app0.bin

   - name: Create Release
     id: create_release
     uses: actions/create-release@v1
     env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     with:
      tag_name: ${{ env.VERSION }}
      release_name: Release ${{ env.VERSION }}
      body: 'Automated release of the firmware'
      draft: false
      prerelease: false

   - name: Upload Release Asset
     id: upload-release-asset
     uses: actions/upload-release-asset@v1
     with:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      asset_path: firmware.zip
      asset_name: firmware.zip
      asset_content_type: application/zip
